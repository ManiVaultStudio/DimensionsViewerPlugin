<!DOCTYPE html>
<html style="padding: 0; margin: 0; width: 100%; height: 100%;">
<head>
    <script type="text/javascript" src="qrc:///qtwebchannel/qwebchannel.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@5"></script>

    <script type="text/javascript" src="qrc:///DimensionsViewer.js"></script>

</head>
	<body style="padding: 0; margin: 0; width: 100%; height: 100%;">
		<div id="view" style="width: 100%; height: 100%; overflow: hidden; "></div>
		<script>
            window.addEventListener("load", function () {
                var onSpecChanged = function (spec) {
                    if (JSON.stringify(spec) === JSON.stringify(window.spec))
                        return;

                    window.spec = spec;

                    window.processingSpec = true;

                    const myNode = document.getElementById("view");

                    while (myNode.firstChild) {
                        myNode.removeChild(myNode.lastChild);
                    }

                    var options = {
                        renderer: "svg",
                        defaultStyle: false
                    };

                    vegaEmbed('#view', getDesign(spec), options).then(p => {

                        // Find elements with tag name details
                        element = document.getElementsByTagName("details");

                        // And remove them (they corrupt the layout)
                        for (index = 0; index < element.length; index++) {
                            element[index].parentNode.removeChild(element[index]);
                        }

                        // Attached the Vega view to the global window variable so that we can later use it
                        window.view = p.view

                        window.processingSpec = false;
                    });
                }

                let checkForSpec = function () {
                    if (window.processingSpec)
                        return;

                    webChannel.objects['specSynchronizer'].getSpec(onSpecChanged);
                }

                new QWebChannel(qt.webChannelTransport,
                    function (webChannel) {
                        window.webChannel = webChannel;

                        window.spec = {};
                        window.processingSpec = false;

                        window.setInterval(checkForSpec, 100);

                        //webChannel.objects['specSynchronizer'].specChanged.connect(onSpecChanged);
                        //webChannel.objects['specSynchronizer'].getSpec(onSpecChanged);
                    });
            });
		</script>
	</body>
</html>