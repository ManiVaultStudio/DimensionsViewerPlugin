<!DOCTYPE html>
<html style="padding: 0; margin: 0; width: 100%; height: 100%;">
<head>
    <script type="text/javascript" src="qrc:///qtwebchannel/qwebchannel.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@5"></script>

    <script type="text/javascript" src="qrc:///DimensionsViewer.js"></script>

</head>
	<body style="padding: 0; margin: 0; width: 100%; height: 100%;">
		<div id="view" style="width: 100%; height: 100%; overflow: hidden; "></div>
		<script>
            window.addEventListener("load", function () {

                // Invoked when channel dimensions have changed
                var onChannelDimensionsChanged = function (channelIndex, dimensions) {
                    view[`dimensions${channelIndex}`] = dimensions;

                    let changeset = vega.changeset().remove(() => true).insert(view['dimensions0'].concat(view['dimensions1']).concat(view['dimensions2']));
                    view.change('dimensions', changeset).run();
                }

                // Invoked when the channel color has changed
                var onChannelColorChanged = function (channelIndex, color) {
                    view.signal(`color${channelIndex}`, color);
                    view.runAsync();
                }
                
                // Create new webchannel and connect to signals from C++
                new QWebChannel(qt.webChannelTransport,
                    function (channel) {
                        let numChannels = 3;

                        // Vega visualization options
                        var options = {
                            renderer: "canvas",
                            defaultStyle: false,
                            patch: (spec) => {
                                for (channelIndex = 0; channelIndex < numChannels; channelIndex++) {
                                    
                                    spec.signals.push({
                                        "name": `color${channelIndex}`,
                                    })
                                }
                                return spec;
                            }
                        };

                        view.dimensions = [];

                        for (channelIndex = 0; channelIndex < numChannels; channelIndex++) {
                            addChannel(design, channelIndex);

                            view[`dimensions${channelIndex}`] = [];

                            // Callback
                            channel.objects[`channel${channelIndex}`].dimensionsChanged.connect(onChannelDimensionsChanged.bind(null, channelIndex));
                            channel.objects[`channel${channelIndex}`].colorChanged.connect(onChannelColorChanged.bind(null, channelIndex));

                            // Initialize
                            channel.objects[`channel${channelIndex}`].getDimensions(onChannelDimensionsChanged.bind(null, channelIndex))
                            channel.objects[`channel${channelIndex}`].getColorName(onChannelColorChanged.bind(null, channelIndex))
                        }

                        // Embed the Vega view
                        vegaEmbed('#view', design, options).then(p => {

                            // Find elements with tag name details
                            element = document.getElementsByTagName("details");

                            // And remove them (they corrupt the layout)
                            for (index = 0; index < element.length; index++) {
                                element[index].parentNode.removeChild(element[index]);
                            }

                            // Attached the Vega view to the global window variable so that we can later use it
                            window.view = p.view
                        });
                    });
            });
		</script>
	</body>
</html>